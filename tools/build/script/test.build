<?xml version="1.0" encoding="utf-8"?>
<project name="Ecm" xmlns="http://nant.sf.net/release/0.85/nant.xsd" basedir=".">

    <target name="test.execute">
    
		<if test="${is.running.statistic=='true'}">
			<call target="test.execute.coverage" />
		</if>
		
		<if test="${is.running.statistic=='false'}">
			<call target="test.execute.default" />
		</if>

    </target>
	
    <target name="test.execute.default">
	
		<echo message="Utilizando configurações de ambiente de testes" />
		<property name="enviroment" value="test" />
	
		<foreach item="File" property="test.file">
			<in>
				<items refid="test.files" />
			</in>
			<do>
				
				<nunitTest
					executable="${buildtools.dir}\nunit\nunit-console.exe"
					workingDirectory="${binary.dir}"
					outputFile="${report.dir}\nunit-result.xml"
					commandLineParameterFlag="-"
					showLabels="true"
					verbose="${nant.verbosity}">

					<assemblies>
						<include name="${test.file}" />
					</assemblies>

				</nunitTest>

			</do>
		</foreach> 
	</target>
	
	<target name="test.execute.coverage">

		<delete>
    		<fileset basedir="${binary.dir}">
    			<include name="*-results.xml" />
				<include name="*-CoverageSummary.xml" />
				<include name="*-coverage.xml" />
    		</fileset>
		</delete>
		<delete>
    		<fileset basedir="${report.dir}">
    			<include name="*-results.xml" />
				<include name="*-CoverageSummary.xml" />
				<include name="*-coverage.xml" />
    		</fileset>
		</delete>		
		
		<setenv>
		  <variable name="ProfAPI_ProfilerCompatibilitySetting" value="EnableV2Profiler" />
		  <variable name="COMPLUS_ProfAPI_ProfilerCompatibilitySetting" value="EnableV2Profiler" />
		</setenv>

		<exec
		  program="${buildtools.dir}\ncover\CorFlags.exe"
		  workingdir="${binary.dir}"
		  commandline="${path::get-full-path('tools\build\ncover\ncover.console.exe')} /32BIT+"/>
		  
		<foreach item="File" property="test.file">
			<in>
				<items refid="test.files" />
			</in>
			<do>

				<exec 
					verbose="true"
					program="${buildtools.dir}\ncover\ncover.console.exe" 
					workingdir="${binary.dir}" 
					commandline="//reg &quot;${buildtools.dir}\nunit\nunit-console-x86.exe&quot; &quot;${test.file}&quot;  /xml:${test.file}-results.xml /nologo //w ${binary.dir} //x ${test.file}-coverage.xml"/>

			</do>
		</foreach> 

		<move todir="${report.dir}">
    		<fileset basedir="${binary.dir}">
    			<include name="*-results.xml" />
				<include name="*-CoverageSummary.xml" />
				<include name="*-coverage.xml" />
    		</fileset>
		</move>

		<ncoverexplorer 
				program="${buildtools.dir}\ncoverexplorer\ncoverexplorer.console.exe" 
				projectName="${project.name}" 
				outputDir="${report.dir}" 
				satisfactoryCoverage="10" 
				reportType="4" 
				xmlReportName="CoverageSummary.xml">
			<fileset basedir="${report.dir}">
				<include name="*-coverage.xml" />
			</fileset>
			
		</ncoverexplorer>

	</target>
</project>